<div th:fragment="content">
    <div class="page-header">
        <h2>User Management</h2>
        <a th:href="@{/admin/users/new}" class="btn btn-primary">Add New User</a>
    </div>
    <div class="table-container">
        <table class="profile-table datatable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="user : ${users}" th:class="${user.enabled} ? 'active' : 'inactive'">
                    <td th:text="${user.username}">username</td>
                    <td th:text="${user.role}">role</td>
                    <td>
                        <span th:if="${user.enabled}" class="status-badge active">Enabled</span>
                        <span th:unless="${user.enabled}" class="status-badge inactive">Disabled</span>
                    </td>
                    <td class="actions">
                        <a th:href="@{'/admin/users/edit/' + ${user.id}}" class="btn-edit" title="Edit">
                            <span class="icon">
                                <!-- Edit SVG icon -->
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M3 14.25V17h2.75l8.09-8.09-2.75-2.75L3 14.25zM17.71 6.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="#2196f3"/></svg>
                            </span>
                        </a>
                        <button type="button"
                            class="btn-password"
                            th:attr="data-user-id=${user.id}, data-username=${user.username}"
                            onclick="openPasswordModal(this)"
                            title="Change Password">
                            <span class="icon">
                                <!-- Password SVG icon -->
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M10 13a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" fill="#f39c12"/><path d="M14 8V7a4 4 0 1 0-8 0v1" stroke="#f39c12" stroke-width="2"/><rect x="4" y="8" width="12" height="8" rx="2" stroke="#f39c12" stroke-width="2"/></svg>
                            </span>
                        </button>
                        <a th:href="@{'/admin/users/delete/' + ${user.id}}"
                           class="btn-delete"
                           onclick="return confirm('Are you sure you want to delete this user?')" title="Delete">
                            <span class="icon">
                                <!-- Delete SVG icon -->
                                <svg width="17" height="17" viewBox="0 0 20 20" fill="none"><path d="M6 7v7a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V7" stroke="#e74c3c" stroke-width="2"/><path d="M4 7h12" stroke="#e74c3c" stroke-width="2"/><path d="M9 10v3" stroke="#e74c3c" stroke-width="2"/><path d="M11 10v3" stroke="#e74c3c" stroke-width="2"/><rect x="6" y="4" width="8" height="2" rx="1" fill="#e74c3c"/></svg>
                            </span>
                        </a>
                    </td>
                </tr>
                <tr th:if="${users.empty}">
                    <td colspan="4" class="no-data">
                        No users found. <a th:href="@{/admin/users/new}">Create the first user</a>
                    </td>
                </tr>
            </tbody>
        </table>
        <!-- Password Modal -->
        <div id="passwordModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePasswordModal()">&times;</span>
                <h3>Change Password for <span id="modalUsername"></span></h3>
                <form method="post" th:action="@{/admin/users/change-password}" onsubmit="return validatePasswordMatch()">
                    <input type="hidden" name="userId" id="modalUserId" />
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" name="newPassword" id="newPassword" required />
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" required />
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Update Password</button>
                        <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
function openPasswordModal(button) {
    const userId = button.getAttribute('data-user-id');
    const username = button.getAttribute('data-username');
    document.getElementById('modalUserId').value = userId;
    document.getElementById('modalUsername').textContent = username;
    document.getElementById('passwordModal').classList.add('show');
}
function closePasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.classList.remove('show');
}
// Close on overlay click and ESC
document.addEventListener('click', (e) => {
    const modal = document.getElementById('passwordModal');
    if (!modal) return;
    if (modal.classList.contains('show') && e.target === modal) {
        closePasswordModal();
    }
});
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePasswordModal();
});
function validatePasswordMatch() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    if (newPassword !== confirmPassword) {
        alert("Passwords do not match.");
        return false;
    }
    return true;
}
</script>